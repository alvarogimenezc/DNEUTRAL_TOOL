#This dashboard uses stremalit library to show the results 
import streamlit as st
import pandas as pd
import plotly.express as px
from pathlib import Path
import time
from datetime import datetime, timedelta
import json
from streamlit_autorefresh import st_autorefresh

#Define format and isert title
st.set_page_config(
    page_title="Herramienta",
    page_icon="ðŸ“ˆ",
    layout="wide"
)

st.title("ðŸ“Š DNeutral tool - dashboard para estrategias delta neutral")
st.subheader("ObtÃ©n una rentabilidad positiva abriendo largos y cortos en diferentes exchanges")

#We need to wait until the json file is available
while not Path("/shared_data/data_api.json").exists():
    print("Esperando datos del backend... (se actualizarÃ¡ automÃ¡ticamente)")
    time.sleep(30) 

#We obtain the data generated by the backend in the volume
with open("/shared_data/data_api.json", "r", encoding="utf-8") as file:
    input = json.load(file)

dict_series=input["dict_series"]
dataset_resultante=input["dataset_resultante"]
timestamp=input["timestamp"]

#Convertimos el texto ISO a datetime y ajustamos una hora, lo formateamos a 'YYYY-MM-DD HH:MM' y lo metemos en un sidebar
ts_local = datetime.fromisoformat(timestamp) + timedelta(hours=1)
ts_str = ts_local.strftime("%Y-%m-%d %H:%M")
st.write(f"Ãšltima actualizaciÃ³n: {ts_str}")

#Obtain the granularity selected by the user
granularidad=st.slider("Seleccione el rango de analisis", 1, 14)

#Create the table to show the results, we need pandas lib. Filter by the selected granularity
st.subheader("Tabla comprarativa resultados")
df = pd.DataFrame(dataset_resultante[f"periodo_{granularidad}"], columns=["LARGO ðŸ“ˆ", "CORTO ðŸ“‰", "APR % ðŸ”¼", "MONEDA ðŸª™"])
st.dataframe(df)

#Lets create the chart for a given coin/dex
st.subheader("ðŸ“ˆ EvoluciÃ³n de Fundings por Exchange y Moneda")

#Define the filters of the chart
exchanges = ["Hyperliquid-Paradex", "Hyperliquid-Lighter", "Paradex-Lighter"]
monedas = sorted({v["Moneda"] for v in dict_series.values()})

col1, col2 = st.columns(2)
selected_exchange = col1.selectbox("Selecciona Exchanges", exchanges)
selected_moneda = col2.selectbox("Selecciona Moneda", monedas)

exchange1, exchange2 = selected_exchange.split("-")

key1 = f"{selected_moneda}_{exchange1}"
key2 = f"{selected_moneda}_{exchange2}"

if key in dict_series:
    data = dict_series[key]
    df_plot = pd.DataFrame({
        "Fecha": data["Fechas"],
        "Funding": data["Fundings"]
    })

    fig = px.line(
        df_plot,
        x="Fecha",
        y="Funding",
        title=f"Funding Rate - {selected_moneda} ({selected_exchange})",
        template="plotly_dark",
    )

    st.plotly_chart(fig, width="stretch")

else:
    pass

#Refresh the data every 90 seconds
count = st_autorefresh(interval=90000)
